{% extends 'base.html' %}

{% block title %}Appointment — {{ appointment.patient.get_full_name|default:appointment.patient.username }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="mb-4">
        <a href="{% url 'doctors:doctor_appointment_list' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to Appointments</a>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Appointment</h5></div>
                <div class="card-body">
                    <p class="mb-1"><strong>Date:</strong> {{ appointment.appointment_date }}</p>
                    <p class="mb-1"><strong>Time:</strong> {{ appointment.appointment_time }}</p>
                    <p class="mb-1"><strong>Hospital:</strong> {{ appointment.hospital.name|default:"—" }}</p>
                    <p class="mb-1"><strong>Status:</strong> <span class="badge bg-{% if appointment.status == 'CONFIRMED' %}success{% elif appointment.status == 'PENDING' %}warning{% elif appointment.status == 'COMPLETED' %}info{% else %}secondary{% endif %}">{{ appointment.get_status_display }}</span></p>
                    <p class="mb-0"><strong>Reason:</strong> {{ appointment.reason }}</p>
                </div>
            </div>
            {% if can_approve_reject %}
            <div class="card shadow-sm">
                <div class="card-body">
                    <p class="small text-muted mb-2">Appointment request from patient — approve or reject.</p>
                    <form method="post" action="{% url 'doctors:doctor_appointment_approve' appointment.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success">Approve</button>
                    </form>
                    <form method="post" action="{% url 'doctors:doctor_appointment_reject' appointment.pk %}" class="d-inline" onsubmit="return confirm('Reject this appointment?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger">Reject</button>
                    </form>
                </div>
            </div>
            {% endif %}
            {% if can_complete and not is_past_completed %}
            <div class="card shadow-sm mt-2">
                <div class="card-body">
                    <form method="post" action="{% url 'doctors:doctor_appointment_complete' appointment.pk %}" onsubmit="return confirm('Mark this appointment as completed?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary">Mark as completed</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header"><h5 class="mb-0">Patient details</h5></div>
                <div class="card-body">
                    <p class="mb-1"><strong>Name:</strong> {{ appointment.patient.get_full_name|default:appointment.patient.username }}</p>
                    <p class="mb-1"><strong>Email:</strong> {{ appointment.patient.email }}</p>
                    {% if appointment.patient.phone_number %}<p class="mb-1"><strong>Phone:</strong> {{ appointment.patient.phone_number }}</p>{% endif %}
                    {% if appointment.patient.address %}<p class="mb-0"><strong>Address:</strong> {{ appointment.patient.address }}</p>{% endif %}
                </div>
            </div>
            {% if not is_past_completed %}
            <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Consultation notes &amp; prescription</h5></div>
                <div class="card-body">
                    <form method="post" action="{% url 'doctors:doctor_appointment_notes' appointment.pk %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea name="notes" class="form-control" rows="4" placeholder="Consultation notes">{{ appointment.notes }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Prescription</label>
                            <textarea name="prescription" class="form-control" rows="4" placeholder="Prescription details">{{ appointment.prescription }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Save notes &amp; prescription</button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Consultation notes &amp; prescription</h5></div>
                <div class="card-body">
                    <p class="mb-2"><strong>Notes:</strong></p>
                    <p class="text-muted">{% if appointment.notes %}{{ appointment.notes }}{% else %}—{% endif %}</p>
                    <p class="mb-2"><strong>Prescription:</strong></p>
                    <p class="text-muted">{% if appointment.prescription %}{{ appointment.prescription }}{% else %}—{% endif %}</p>
                    <p class="small text-muted mb-0">Completed appointments cannot be edited.</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
